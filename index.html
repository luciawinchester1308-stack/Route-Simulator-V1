<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROUTE SIMULATOR</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap');

  :root {
    --bg:     #080c10;
    --panel:  #0d1117;
    --border: #1a2535;
    --accent: #00e5ff;
    --accent2:#ff6b35;
    --green:  #00ff88;
    --blue:   #4285f4;
    --text:   #e0eaf5;
    --muted:  #4a6080;
    --glow:   0 0 20px rgba(0,229,255,0.3);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 11px 24px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(90deg,#080c10,#0d1520);
    flex-shrink: 0;
    z-index: 10;
  }
  .logo { font-family:'Orbitron',monospace; font-size:15px; font-weight:900; letter-spacing:4px; color:var(--accent); text-shadow:var(--glow); }
  .logo span { color:var(--accent2); }
  .live-clock { font-family:'Orbitron',monospace; font-size:13px; color:var(--accent); letter-spacing:2px; }
  .status-bar { display:flex; gap:16px; align-items:center; font-size:10px; letter-spacing:1.5px; color:var(--muted); font-family:'Orbitron',monospace; }
  .status-pill { display:flex; align-items:center; gap:6px; }
  .dot { width:7px; height:7px; border-radius:50%; background:var(--muted); transition:all 0.4s; }
  .dot.on   { background:var(--green);   box-shadow:0 0 8px var(--green); }
  .dot.warn { background:var(--accent2); box-shadow:0 0 8px var(--accent2); }

  /* BUTTONS */
  .btn {
    background:transparent; border:1px solid var(--accent); color:var(--accent);
    padding:11px 20px; font-family:'Orbitron',monospace; font-size:9px;
    letter-spacing:3px; cursor:pointer; transition:all 0.2s; width:100%;
  }
  .btn:hover:not(:disabled) { background:var(--accent); color:var(--bg); box-shadow:var(--glow); }
  .btn:disabled { opacity:0.28; cursor:not-allowed; }
  .btn.orange { border-color:var(--accent2); color:var(--accent2); }
  .btn.orange:hover:not(:disabled) { background:var(--accent2); color:var(--bg); }
  .btn.green  { border-color:var(--green); color:var(--green); }
  .btn.green:hover:not(:disabled)  { background:var(--green);  color:var(--bg); }

  /* MAIN */
  .main { flex:1; display:grid; grid-template-columns:310px 1fr; overflow:hidden; position:relative; transition: grid-template-columns 0.3s ease; }
  .main.panel-hidden { grid-template-columns: 0px 1fr; }

  /* SIDE */
  .side { display:flex; flex-direction:column; border-right:1px solid var(--border); background:var(--panel); overflow:hidden; transition: transform 0.3s ease, width 0.3s ease; width:310px; min-width:310px; }
  .main.panel-hidden .side { transform: translateX(-310px); margin-right: -310px; }

  /* Toggle button â€” floats over the map edge */
  #panel-toggle {
    position: absolute;
    top: 50%;
    left: 310px;
    transform: translateY(-50%) translateX(-50%);
    z-index: 30;
    width: 22px;
    height: 48px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-left: none;
    border-radius: 0 6px 6px 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    font-size: 11px;
    transition: left 0.3s ease, color 0.2s, background 0.2s;
  }
  #panel-toggle:hover { color: var(--accent); background: #111922; }
  .main.panel-hidden #panel-toggle { left: 0; border-left: 1px solid var(--border); border-radius: 0 6px 6px 0; }

  .side-scroll { flex:1; overflow-y:auto; scroll-behavior:smooth; }
  .side-scroll::-webkit-scrollbar { width:3px; }
  .side-scroll::-webkit-scrollbar-thumb { background:var(--border); }

  /* Sticky nav inside side panel */
  .side-nav {
    display: flex;
    flex-shrink: 0;
    background: #080c10;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 5;
  }
  .side-nav-btn {
    flex: 1;
    padding: 7px 2px;
    background: transparent;
    border: none;
    border-right: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Orbitron', monospace;
    font-size: 7px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .side-nav-btn:last-child { border-right: none; }
  .side-nav-btn:hover { color: var(--text); background: rgba(255,255,255,0.03); }
  .side-nav-btn.lit { color: var(--accent); }

  .sec  { padding:14px 18px; border-bottom:1px solid var(--border); flex-shrink:0; }
  .sec-label { font-family:'Orbitron',monospace; font-size:8px; letter-spacing:3px; color:var(--muted); margin-bottom:10px; text-transform:uppercase; }

  /* Search */
  .search-row {
    display:flex; align-items:center; gap:9px;
    background:var(--bg); border:1px solid var(--border);
    padding:9px 11px; margin-bottom:7px; transition:border-color 0.3s;
  }
  .search-row:focus-within { border-color:var(--accent); }
  .search-row .pin { font-size:13px; flex-shrink:0; }
  .search-row input { background:none; border:none; color:var(--text); font-family:'Rajdhani',sans-serif; font-size:13px; width:100%; outline:none; }
  .search-row input::placeholder { color:var(--muted); }

  /* Time input */
  .time-row {
    display:flex; align-items:center; gap:9px;
    background:var(--bg); border:1px solid var(--border);
    padding:9px 11px; margin-bottom:5px; transition:border-color 0.3s;
  }
  .time-row:focus-within { border-color:var(--accent2); box-shadow:0 0 0 1px rgba(255,107,53,0.1); }
  .time-row .pin { font-size:13px; flex-shrink:0; }
  .time-row input[type="time"] {
    background:none; border:none; color:var(--accent2);
    font-family:'Orbitron',monospace; font-size:13px;
    width:100%; outline:none; letter-spacing:2px;
    color-scheme: dark;
  }
  .time-hint { font-size:10px; color:var(--muted); letter-spacing:0.5px; }

  /* Waiting banner */
  #wait-banner {
    display:none;
    background:rgba(255,107,53,0.08);
    border:1px solid rgba(255,107,53,0.3);
    padding:9px 12px;
    margin-top:8px;
    font-family:'Orbitron',monospace;
    font-size:10px;
    color:var(--accent2);
    letter-spacing:1px;
    text-align:center;
  }

  /* Speedometer */
  .speedo-sec { padding:12px 18px 8px; border-bottom:1px solid var(--border); display:flex; flex-direction:column; align-items:center; flex-shrink:0; }
  canvas#speedo { width:274px; height:154px; display:block; }
  .speed-num { text-align:center; margin-top:-2px; }
  .speed-val { font-family:'Orbitron',monospace; font-size:46px; font-weight:900; color:var(--blue); text-shadow:0 0 20px rgba(66,133,244,0.5); line-height:1; }
  .speed-unit { font-size:11px; letter-spacing:4px; color:var(--muted); margin-top:2px; }

  /* Stats */
  .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:5px; }
  .sbox { background:var(--bg); border:1px solid var(--border); padding:9px 11px; }
  .sbox-label { font-size:8px; letter-spacing:2px; color:var(--muted); text-transform:uppercase; }
  .sbox-val { font-family:'Orbitron',monospace; font-size:14px; color:var(--text); margin-top:3px; }
  .sbox-val.c { color:var(--accent); }
  .sbox-val.o { color:var(--accent2); }
  .sbox-val.g { color:var(--green); }
  .sbox-val.b { color:#7ab4ff; }

  /* Controls */
  .ctrl { padding:11px 18px; display:flex; flex-direction:column; gap:6px; border-bottom:1px solid var(--border); flex-shrink:0; }
  .compound-toggle-wrap { margin-top:4px; }
  .compound-toggle { display:flex; gap:4px; flex-wrap:wrap; }
  .ctog {
    flex:1; min-width:0;
    padding:7px 4px;
    background:transparent; border:1px solid var(--border);
    color:var(--muted); font-family:'Orbitron',monospace; font-size:8px;
    letter-spacing:1px; cursor:pointer; transition:all 0.2s;
  }
  .ctog:hover { border-color:var(--accent); color:var(--text); }
  .ctog.active { border-color:var(--accent); color:var(--accent); background:rgba(0,229,255,0.08); }

  @keyframes fadeIn { from { opacity:0; transform:translateX(-5px); } to { opacity:1; } }

  /* MAP */
  #map-container { position:relative; flex:1; overflow:hidden; }
  #map { width:100%; height:100%; }

  /* Progress bar */
  .progress-bar-wrap { position:absolute; bottom:0; left:0; right:0; height:4px; background:rgba(26,37,53,0.8); z-index:5; }
  .progress-bar-fill { height:100%; background:linear-gradient(90deg,var(--blue),var(--green)); width:0%; transition:width 0.4s linear; box-shadow:0 0 8px var(--blue); }

  /* Blue dot tracker (no pulse) */
  .tracker-dot {
    width: 18px; height: 18px;
    background: #4285f4;
    border-radius: 50%;
    border: 3px solid #ffffff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.6), 0 0 0 3px rgba(66,133,244,0.25);
    position: absolute;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 10;
  }

  /* Completion overlay */
  #complete-overlay { position:absolute; inset:0; background:rgba(8,12,16,0.88); display:none; align-items:center; justify-content:center; z-index:20; backdrop-filter:blur(4px); }
  #complete-overlay.show { display:flex; }
  .complete-card { border:1px solid var(--green); background:var(--panel); padding:36px 40px; text-align:center; box-shadow:0 0 40px rgba(0,255,136,0.2); max-width:400px; width:90%; position:relative; }
  .complete-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--green),transparent); }
  .complete-card h2 { font-family:'Orbitron',monospace; font-size:9px; letter-spacing:4px; color:var(--green); margin-bottom:6px; }
  .complete-card .final-speed { font-family:'Orbitron',monospace; font-size:50px; font-weight:900; color:var(--green); text-shadow:0 0 30px var(--green); line-height:1; margin:10px 0 2px; }
  .complete-card .unit { font-size:11px; letter-spacing:3px; color:var(--muted); margin-bottom:14px; }
  .complete-card p { color:var(--muted); font-size:12px; margin-bottom:22px; line-height:1.6; }

  /* Mobile */
  @media (max-width: 640px) {
    .main { grid-template-columns: 280px 1fr; }
    .side { width: 280px; min-width: 280px; }
    .main.panel-hidden .side { transform: translateX(-280px); margin-right: -280px; }
    #panel-toggle { left: 280px; }
    canvas#speedo { width: 244px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">ROUTE<span>SIM</span></div>
  <div class="live-clock" id="live-clock">--:--:--</div>
  <div class="status-bar">
    <div class="status-pill"><div class="dot" id="dot-maps"></div><span>MAPS</span></div>
    <div class="status-pill"><div class="dot" id="dot-route"></div><span>ROUTE</span></div>
    <div class="status-pill"><div class="dot" id="dot-sim"></div><span>SIM</span></div>
  </div>
</header>

<div class="main" id="main">
  <button id="panel-toggle" onclick="togglePanel()" title="Toggle panel">â—€</button>
  <!-- SIDE PANEL -->
  <div class="side">

    <!-- Sticky section nav -->
    <nav class="side-nav">
      <button class="side-nav-btn lit" onclick="scrollToSection('section-route')">Route</button>
      <button class="side-nav-btn"     onclick="scrollToSection('section-speed')">Speed</button>
      <button class="side-nav-btn"     onclick="scrollToSection('section-telemetry')">Data</button>
      <button class="side-nav-btn"     onclick="scrollToSection('section-controls')">Ctrl</button>
    </nav>

    <div class="side-scroll" id="side-scroll">

    <!-- ROUTE SETUP -->
    <div class="sec" id="section-route">
      <div class="sec-label">// Route Setup</div>
      <div class="search-row">
        <span class="pin">ğŸŸ¢</span>
        <input type="text" id="origin-input" placeholder="Origin â€” search address..." />
      </div>
      <div class="search-row">
        <span class="pin">ğŸ”´</span>
        <input type="text" id="dest-input" placeholder="Destination â€” search address..." />
      </div>

      <div style="margin-top:10px;">
        <div class="sec-label" style="margin-bottom:6px;">// Departure Time</div>
        <div class="time-row">
          <span class="pin">ğŸ•</span>
          <input type="time" id="start-time-input" />
        </div>
        <div class="time-hint">Leave as now to start immediately</div>
        <div id="wait-banner">â³ WAITING FOR DEPARTURE...</div>
      </div>

      <button class="btn" style="margin-top:10px;" onclick="calculateRoute()">CALCULATE ROUTE</button>
    </div>

    <!-- SPEEDOMETER -->
    <div class="speedo-sec" id="section-speed">
      <div class="sec-label" style="align-self:flex-start">// Velocity</div>
      <canvas id="speedo" width="274" height="154"></canvas>
      <div class="speed-num">
        <div class="speed-val" id="speed-val">0.10</div>
        <div class="speed-unit">KM / H</div>
      </div>
    </div>

    <!-- TELEMETRY -->
    <div class="sec" id="section-telemetry">
      <div class="sec-label">// Telemetry</div>
      <div class="stats-grid">
        <div class="sbox">
          <div class="sbox-label">Route Time</div>
          <div class="sbox-val c" id="stat-elapsed">00:00</div>
        </div>
        <div class="sbox">
          <div class="sbox-label">Distance</div>
          <div class="sbox-val" id="stat-dist">â€” km</div>
        </div>
        <div class="sbox">
          <div class="sbox-label">Progress</div>
          <div class="sbox-val o" id="stat-progress">0.0%</div>
        </div>
        <div class="sbox">
          <div class="sbox-label">Next +1%</div>
          <div class="sbox-val g" id="stat-nexttick">60s</div>
        </div>

      </div>
    </div>

    <!-- CONTROLS -->
    <div class="ctrl" id="section-controls">
      <button class="btn green"  id="btn-start"       onclick="startSim()"          disabled>â–¶ START SIMULATION</button>
      <button class="btn orange" id="btn-pause"        onclick="pauseSim()"          disabled>â¸ PAUSE</button>
      <button class="btn"        id="btn-reset-route"  onclick="resetRouteProgress()" disabled>â†º RESET ROUTE PROGRESS</button>
      <button class="btn"        id="btn-reset"        onclick="resetSim()"          disabled>â¹ FULL RESET</button>
      <div class="compound-toggle-wrap">
        <div class="sec-label" style="margin-bottom:7px;">// Increment per minute</div>
        <div class="compound-toggle" id="compound-toggle">
          <button class="ctog active" onclick="setCompound(1.01, this)">Ã—1.01</button>
          <button class="ctog"        onclick="setCompound(1.02, this)">Ã—1.02</button>
          <button class="ctog"        onclick="setCompound(1.05, this)">Ã—1.05</button>
        </div>
      </div>
    </div>

    </div><!-- end side-scroll -->
  </div>

  <!-- MAP -->
  <div id="map-container">
    <div id="map"></div>
    <div class="progress-bar-wrap">
      <div class="progress-bar-fill" id="progress-fill"></div>
    </div>

    <div id="complete-overlay">
      <div class="complete-card">
        <h2>// DESTINATION REACHED</h2>
        <div style="color:var(--muted);font-size:11px;letter-spacing:2px;">FINAL SPEED</div>
        <div class="final-speed" id="final-speed">â€”</div>
        <div class="unit">KM / H</div>
        <p id="final-stats">â€”</p>
        <button class="btn" style="border-color:var(--green);color:var(--green);"
          onclick="resetSim();document.getElementById('complete-overlay').classList.remove('show')">
          NEW ROUTE
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_KEY     = 'AIzaSyAVb9rbrhEfJVcHOQdLK6yU-UKlrMJLJjE';
const TICK_MS     = 200;
const COMPOUND_MS = 60000; // 1 real minute â†’ +1% speed

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let map, directionsService;
let routePath        = [];
let routeDistanceKm  = 0;

// Polylines
let greyPolyline  = null;
let travelledLine = null;
let remainingLine = null;

// Dot tracker
let trackerMarker = null;

// Sim state
let speed           = 0.1;
let simRunning      = false;
let simPaused       = false;
let tickCount       = 0;
let elapsedMs       = 0;
let lastTickTime    = null;
let minuteAccumMs   = 0;
let distTravelledKm = 0;
let compoundCount   = 0;
let simInterval     = null;
let waitInterval    = null;
let scheduledStart  = null;
let lastPathIdx     = 0;
let compoundMs      = 0;  // total ms for compound growth â€” never resets

let compoundMultiplier = 1.01; // changeable via toggle
function tickClock() {
  const now = new Date();
  document.getElementById('live-clock').textContent =
    fmt(now.getHours()) + ':' + fmt(now.getMinutes()) + ':' + fmt(now.getSeconds());
}
setInterval(tickClock, 1000);
tickClock();

// â”€â”€â”€ LOAD MAPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places&callback=onMapsLoaded`;
  s.onerror = () => alert('Google Maps failed to load. Check the API key and enabled APIs (Maps JS, Directions, Places).');
  document.head.appendChild(s);
})();

window.onMapsLoaded = function() {
  document.getElementById('dot-maps').classList.add('on');

  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 40.4168, lng: -3.7038 },
    zoom: 12,
    styles: darkMapStyle(),
    zoomControl: true,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: true,
    gestureHandling: 'greedy',
  });

  directionsService = new google.maps.DirectionsService();

  new google.maps.places.Autocomplete(document.getElementById('origin-input'));
  new google.maps.places.Autocomplete(document.getElementById('dest-input'));

  // Default time = now
  const now = new Date();
  document.getElementById('start-time-input').value = fmt(now.getHours()) + ':' + fmt(now.getMinutes());

  drawSpeedo(0.1);
};

// â”€â”€â”€ CALCULATE ROUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Preserves speed, elapsed time and compound count â€” only resets route progress.
function calculateRoute() {
  const origin = document.getElementById('origin-input').value.trim();
  const dest   = document.getElementById('dest-input').value.trim();
  if (!origin || !dest) { alert('Enter both origin and destination.'); return; }

  // If sim is running, pause it while we fetch
  const wasRunning = simRunning;
  if (wasRunning) { clearInterval(simInterval); simRunning = false; }

  // Clear map overlays only
  if (greyPolyline)  { greyPolyline.setMap(null);  greyPolyline = null; }
  if (travelledLine) { travelledLine.setMap(null);  travelledLine = null; }
  if (remainingLine) { remainingLine.setMap(null);  remainingLine = null; }
  if (trackerMarker) { trackerMarker.setMap(null);  trackerMarker = null; }

  directionsService.route({
    origin, destination: dest,
    travelMode: google.maps.TravelMode.DRIVING,
  }, (result, status) => {
    if (status !== 'OK') {
      alert('Could not get directions: ' + status);
      // Resume if we paused
      if (wasRunning) { simRunning = true; lastTickTime = performance.now(); simInterval = setInterval(simTick, TICK_MS); }
      return;
    }

    document.getElementById('dot-route').classList.add('on');

    const legs = result.routes[0].legs;
    routeDistanceKm = legs.reduce((a, l) => a + l.distance.value, 0) / 1000;
    document.getElementById('stat-dist').textContent = routeDistanceKm.toFixed(2) + ' km';

    routePath = [];
    legs.forEach(leg => leg.steps.forEach(step => step.path.forEach(pt => routePath.push(pt))));

    // Blue travelled line (starts empty, fills as vehicle moves)
    travelledLine = new google.maps.Polyline({
      path: [], strokeColor: '#4285f4', strokeOpacity: 1, strokeWeight: 7, map, zIndex: 2,
    });
    // Grey remaining line (starts as full route, shrinks as vehicle moves)
    remainingLine = new google.maps.Polyline({
      path: routePath, strokeColor: '#4285f4', strokeOpacity: 0.25, strokeWeight: 7, map, zIndex: 1,
    });

    // Origin / destination pins
    new google.maps.Marker({
      position: routePath[0], map,
      icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#00c853', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2.5 },
      title: 'Origin', zIndex: 4,
    });
    new google.maps.Marker({
      position: routePath[routePath.length - 1], map,
      icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#e53935', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2.5 },
      title: 'Destination', zIndex: 4,
    });

    // Fit map
    const bounds = new google.maps.LatLngBounds();
    routePath.forEach(pt => bounds.extend(pt));
    map.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });

    // Reset route-only state (keep speed, minuteAccumMs, compoundMs, compoundCount)
    distTravelledKm = 0;
    elapsedMs       = 0;
    lastPathIdx     = 0;
    tickCount       = 0;
    document.getElementById('stat-progress').textContent = '0.0%';
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('stat-elapsed').textContent  = '00:00';

    // Place tracker at start
    placeTracker(routePath[0]);
    document.getElementById('complete-overlay').classList.remove('show');

    document.getElementById('btn-reset-route').disabled = false;
    document.getElementById('btn-reset').disabled = false;

    if (wasRunning) {
      // Was mid-run â€” resume automatically on new route
      simRunning   = true;
      lastTickTime = performance.now();
      simInterval  = setInterval(simTick, TICK_MS);
      document.getElementById('btn-start').disabled = true;
      document.getElementById('btn-pause').disabled = false;
      document.getElementById('dot-sim').classList.add('on');
    } else {
      // Was stopped, paused, or completed â€” let user press Start
      simPaused    = false;
      simRunning   = false;
      document.getElementById('btn-start').textContent = 'â–¶ START SIMULATION';
      document.getElementById('btn-start').disabled = false;
      document.getElementById('btn-pause').disabled = true;
      document.getElementById('dot-sim').classList.remove('on', 'warn');
    }
  });
}

// â”€â”€â”€ RESET ROUTE PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Resets position/progress on route but keeps speed, elapsed time, compounds.
function resetRouteProgress() {
  if (!routePath.length) return;

  // Pause sim if running
  const wasRunning = simRunning;
  if (wasRunning) { clearInterval(simInterval); simRunning = false; }

  distTravelledKm = 0;
  elapsedMs       = 0;
  tickCount       = 0;
  lastPathIdx     = 0;
  if (travelledLine) travelledLine.setPath([]);
  if (remainingLine) remainingLine.setPath(routePath);
  if (trackerMarker) trackerMarker.setPosition(routePath[0]);

  document.getElementById('stat-progress').textContent = '0.0%';
  document.getElementById('progress-fill').style.width = '0%';
  document.getElementById('stat-elapsed').textContent  = '00:00';

  // If it was running, resume from start of route
  if (wasRunning) {
    simRunning   = true;
    lastTickTime = performance.now();
    simInterval  = setInterval(simTick, TICK_MS);
  }
}

// â”€â”€â”€ PLACE TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function placeTracker(position) {
  if (trackerMarker) trackerMarker.setMap(null);
  trackerMarker = new google.maps.Marker({
    position, map,
    icon: {
      url: 'data:image/svg+xml,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="11" fill="rgba(66,133,244,0.2)"/>
          <circle cx="12" cy="12" r="8"  fill="#4285f4"/>
          <circle cx="12" cy="12" r="5"  fill="white"/>
          <circle cx="12" cy="12" r="4"  fill="#4285f4"/>
        </svg>`),
      anchor: new google.maps.Point(12, 12),
      scaledSize: new google.maps.Size(24, 24),
    },
    zIndex: 10, title: 'Vehicle',
  });
}

// â”€â”€â”€ SIMULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSim() {
  if (!routePath.length) return;

  // Handle scheduled departure time
  if (!simPaused) {
    const timeVal = document.getElementById('start-time-input').value;
    if (timeVal) {
      const [hh, mm] = timeVal.split(':').map(Number);
      const now = new Date();
      let sched = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
      // If the chosen time is already past, start now
      if (sched > now) {
        scheduledStart = sched;
        document.getElementById('btn-start').disabled = true;
        document.getElementById('btn-reset').disabled = false;
        document.getElementById('wait-banner').style.display = 'block';

        waitInterval = setInterval(() => {
          const rem = scheduledStart - new Date();
          if (rem <= 0) {
            clearInterval(waitInterval);
            document.getElementById('wait-banner').style.display = 'none';
            scheduledStart = null;
            beginSim();
          } else {
            const s = Math.ceil(rem / 1000);
            const m = Math.floor(s / 60);
            document.getElementById('wait-banner').textContent =
              `â³ DEPARTURE IN ${m}m ${fmt(s % 60)}s`;
          }
        }, 500);
        return;
      }
    }
  }

  beginSim();
}

function beginSim() {
  if (simPaused) {
    // Resume from pause
    simPaused    = false;
    simRunning   = true;
    lastTickTime = performance.now();
    document.getElementById('btn-pause').disabled = false;
    document.getElementById('btn-start').disabled = true;
    document.getElementById('dot-sim').classList.add('on');
    document.getElementById('dot-sim').classList.remove('warn');
    simInterval = setInterval(simTick, TICK_MS);
    return;
  }

  // Fresh start on current route
  simPaused       = false;
  simRunning      = true;
  distTravelledKm = 0;
  elapsedMs       = 0;
  lastPathIdx     = 0;
  tickCount       = 0;
  lastTickTime    = performance.now();

  document.getElementById('dot-sim').classList.add('on');
  document.getElementById('dot-sim').classList.remove('warn');
  document.getElementById('btn-start').textContent = 'â–¶ START SIMULATION';
  document.getElementById('btn-start').disabled = true;
  document.getElementById('btn-pause').disabled = false;
  document.getElementById('btn-reset-route').disabled = false;
  document.getElementById('btn-reset').disabled = false;

  placeTracker(routePath[0]);
  if (travelledLine) travelledLine.setPath([]);
  if (remainingLine) remainingLine.setPath(routePath);

  simInterval = setInterval(simTick, TICK_MS);
}

function pauseSim() {
  if (!simRunning) return;
  clearInterval(simInterval);
  simPaused  = true;
  simRunning = false;
  document.getElementById('btn-start').textContent = 'â–¶ RESUME';
  document.getElementById('btn-start').disabled = false;
  document.getElementById('btn-pause').disabled = true;
  document.getElementById('dot-sim').classList.remove('on');
  document.getElementById('dot-sim').classList.add('warn');
}

function resetSim(clearPath = true) {
  clearInterval(simInterval);
  clearInterval(waitInterval);
  simRunning = simPaused = false;
  speed = 0.1; tickCount = 0; elapsedMs = 0;
  minuteAccumMs = 0; distTravelledKm = 0; compoundCount = 0;
  scheduledStart = null; lastPathIdx = 0; compoundMs = 0;

  document.getElementById('speed-val').textContent = '0.10';
  document.getElementById('stat-elapsed').textContent = '00:00';
  document.getElementById('stat-progress').textContent = '0.0%';
  document.getElementById('stat-nexttick').textContent = '60s';
  document.getElementById('progress-fill').style.width = '0%';
  document.getElementById('wait-banner').style.display = 'none';
  document.getElementById('btn-start').textContent = 'â–¶ START SIMULATION';
  document.getElementById('btn-start').disabled = clearPath;
  document.getElementById('btn-pause').disabled = true;
  document.getElementById('btn-reset-route').disabled = true;
  document.getElementById('btn-reset').disabled = true;
  document.getElementById('dot-sim').classList.remove('on','warn');

  if (trackerMarker) { trackerMarker.setMap(null); trackerMarker = null; }
  if (travelledLine) travelledLine.setPath([]);
  if (remainingLine) remainingLine.setPath([]);

  if (clearPath) {
    routePath = []; routeDistanceKm = 0;
    document.getElementById('stat-dist').textContent = 'â€” km';
    document.getElementById('dot-route').classList.remove('on');
    if (greyPolyline)  { greyPolyline.setMap(null);  greyPolyline = null; }
    if (travelledLine) { travelledLine.setMap(null);  travelledLine = null; }
    if (remainingLine) { remainingLine.setMap(null);  remainingLine = null; }
  } else if (routePath.length) {
    document.getElementById('btn-start').disabled = false;
  }

  drawSpeedo(0.1);
}

// â”€â”€â”€ MAIN TICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function simTick() {
  const now = performance.now();
  const dtMs = now - lastTickTime;
  lastTickTime = now;

  elapsedMs     += dtMs;
  minuteAccumMs += dtMs;
  compoundMs    += dtMs;
  tickCount++;

  // â”€â”€ Compound speed every real minute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (minuteAccumMs >= COMPOUND_MS) {
    minuteAccumMs -= COMPOUND_MS;
    speed = speed * compoundMultiplier;
    compoundCount++;
  }

  // â”€â”€ Move vehicle along path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  distTravelledKm += speed * (dtMs / 3600000);
  const progress  = Math.min(distTravelledKm / routeDistanceKm, 1);

  const targetIdx = progress * (routePath.length - 1);
  const idx       = Math.floor(targetIdx);
  const frac      = targetIdx - idx;

  let currentPos;
  if (idx < routePath.length - 1) {
    const p1 = routePath[idx], p2 = routePath[idx + 1];
    currentPos = new google.maps.LatLng(
      p1.lat() + (p2.lat() - p1.lat()) * frac,
      p1.lng() + (p2.lng() - p1.lng()) * frac
    );
  } else {
    currentPos = routePath[routePath.length - 1];
  }

  // Move dot
  if (trackerMarker) trackerMarker.setPosition(currentPos);

  // Blue travelled: origin â†’ currentPos
  if (travelledLine) {
    const travelled = routePath.slice(0, idx + 1);
    travelled.push(currentPos);
    travelledLine.setPath(travelled);
  }

  // Grey remaining: currentPos â†’ destination (no overlap = no grey bleed)
  if (remainingLine) {
    const remaining = [currentPos, ...routePath.slice(idx + 1)];
    remainingLine.setPath(remaining);
  }

  // Pan camera to follow (every ~3s)
  if (tickCount % 15 === 0) map.panTo(currentPos);

  // â”€â”€ Update UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('speed-val').textContent = speed < 1 ? speed.toFixed(4) : speed.toFixed(2);
  drawSpeedo(speed);

  if (tickCount % 8 === 0) {
    const totalSec = Math.floor(elapsedMs / 1000);
    document.getElementById('stat-elapsed').textContent  = fmt(Math.floor(totalSec / 60)) + ':' + fmt(totalSec % 60);
    document.getElementById('stat-progress').textContent = (progress * 100).toFixed(1) + '%';
    document.getElementById('stat-nexttick').textContent = Math.ceil((COMPOUND_MS - minuteAccumMs) / 1000) + 's';
    document.getElementById('progress-fill').style.width = (progress * 100) + '%';
  }

  // â”€â”€ Completion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (progress >= 1) {
    clearInterval(simInterval);
    simRunning = false;
    if (trackerMarker) trackerMarker.setPosition(routePath[routePath.length - 1]);
    const totalSec = Math.floor(elapsedMs / 1000);
    document.getElementById('final-speed').textContent = speed < 1 ? speed.toFixed(4) : speed.toFixed(2);
    document.getElementById('final-stats').textContent =
      `Completed in ${Math.floor(totalSec / 60)}m ${totalSec % 60}s\n${compoundCount} compound events Â· ${routeDistanceKm.toFixed(2)} km`;
    document.getElementById('complete-overlay').classList.add('show');
    document.getElementById('dot-sim').classList.remove('on');
    document.getElementById('dot-sim').classList.add('warn');
    document.getElementById('btn-start').textContent = 'â–¶ START SIMULATION';
    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-pause').disabled = true;
  }
}

// â”€â”€â”€ COMPOUND TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setCompound(value, el) {
  compoundMultiplier = value;
  document.querySelectorAll('.ctog').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) { return String(n).padStart(2, '0'); }

// â”€â”€â”€ SPEEDOMETER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSpeedo(spd) {
  const canvas = document.getElementById('speedo');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const cx = W / 2, cy = H - 14;
  const r  = 108;

  ctx.clearRect(0, 0, W, H);

  const startA = Math.PI;
  const maxSpd = 0.1 * Math.pow(2, 14); // 1638.4 km/h
  // Logarithmic scale: 14 segments, each = one doubling from 0.1
  // pct = log2(spd / 0.1) / 14
  const pct = Math.min(Math.max(Math.log2(Math.max(spd, 0.0001) / 0.1) / 14, 0), 1);

  // Background arc
  ctx.beginPath();
  ctx.arc(cx, cy, r, startA, 2 * Math.PI);
  ctx.strokeStyle = '#1a2535';
  ctx.lineWidth   = 15;
  ctx.lineCap     = 'round';
  ctx.stroke();

  // Value arc â€” blue â†’ orange â†’ red
  const arcColor = pct < 0.6 ? '#4285f4' : pct < 0.85 ? '#ff6b35' : '#ff2244';
  ctx.beginPath();
  ctx.arc(cx, cy, r, startA, startA + pct * Math.PI);
  ctx.strokeStyle  = arcColor;
  ctx.lineWidth    = 15;
  ctx.lineCap      = 'round';
  ctx.shadowColor  = arcColor;
  ctx.shadowBlur   = 16;
  ctx.stroke();
  ctx.shadowBlur   = 0;

  // Tick marks â€” 14 segments
  for (let i = 0; i <= 14; i++) {
    const a   = startA + (i / 14) * Math.PI;
    const big = i % 2 === 0;
    const r1  = r - 20, r2 = r1 - (big ? 12 : 6);
    ctx.beginPath();
    ctx.moveTo(cx + r1 * Math.cos(a), cy + r1 * Math.sin(a));
    ctx.lineTo(cx + r2 * Math.cos(a), cy + r2 * Math.sin(a));
    ctx.strokeStyle = big ? '#4a6080' : '#253040';
    ctx.lineWidth   = big ? 2 : 1;
    ctx.shadowBlur  = 0;
    ctx.stroke();
  }

  // Needle
  const na = startA + pct * Math.PI;
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + (r - 24) * Math.cos(na), cy + (r - 24) * Math.sin(na));
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth   = 2.5;
  ctx.lineCap     = 'round';
  ctx.shadowColor = '#ffffff';
  ctx.shadowBlur  = 8;
  ctx.stroke();
  ctx.shadowBlur  = 0;

  // Hub
  ctx.beginPath();
  ctx.arc(cx, cy, 6, 0, 2 * Math.PI);
  ctx.fillStyle   = '#4285f4';
  ctx.shadowColor = '#4285f4';
  ctx.shadowBlur  = 12;
  ctx.fill();
  ctx.shadowBlur  = 0;
}

// â”€â”€â”€ DARK MAP STYLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function darkMapStyle() {
  return [
    { elementType:'geometry',                                          stylers:[{color:'#0d1117'}] },
    { elementType:'labels.text.fill',                                  stylers:[{color:'#4a6080'}] },
    { elementType:'labels.text.stroke',                                stylers:[{color:'#080c10'}] },
    { featureType:'administrative', elementType:'geometry.stroke',     stylers:[{color:'#1a2535'}] },
    { featureType:'road',           elementType:'geometry',            stylers:[{color:'#1e2d40'}] },
    { featureType:'road',           elementType:'labels.text.fill',    stylers:[{color:'#6b8caf'}] },
    { featureType:'road.highway',   elementType:'geometry',            stylers:[{color:'#2a3f58'}] },
    { featureType:'road.highway',   elementType:'geometry.stroke',     stylers:[{color:'#1a2535'}] },
    { featureType:'road.highway',   elementType:'labels.text.fill',    stylers:[{color:'#8fb0d4'}] },
    { featureType:'water',          elementType:'geometry',            stylers:[{color:'#050a0e'}] },
    { featureType:'landscape',      elementType:'geometry',            stylers:[{color:'#0d1520'}] },
    { featureType:'poi',                                               stylers:[{visibility:'off'}] },
    { featureType:'transit',                                           stylers:[{visibility:'off'}] },
  ];
}

drawSpeedo(0.1);

// â”€â”€â”€ PANEL TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePanel() {
  const main = document.getElementById('main');
  const btn  = document.getElementById('panel-toggle');
  const hidden = main.classList.toggle('panel-hidden');
  btn.textContent = hidden ? 'â–¶' : 'â—€';
}
function scrollToSection(id) {
  const el        = document.getElementById(id);
  const container = document.getElementById('side-scroll');
  if (el && container) {
    container.scrollTo({ top: el.offsetTop - container.offsetTop, behavior: 'smooth' });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('side-scroll');
  if (!container) return;
  const sections = ['section-route','section-speed','section-telemetry','section-controls'];
  const btns     = document.querySelectorAll('.side-nav-btn');
  container.addEventListener('scroll', function() {
    let active = 0;
    sections.forEach((id, i) => {
      const el = document.getElementById(id);
      if (el && (el.offsetTop - container.offsetTop) <= container.scrollTop + 24) active = i;
    });
    btns.forEach((b, i) => b.classList.toggle('lit', i === active));
  });
});
</script>
</body>
</html>
